<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.leechain.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Java多线程之哲学家就餐问题哲学家就餐问题是在计算机科学中的一个经典问题，常常被用来面试。这个问题显示了多线程同步(Synchronization)时产生的问题。 在1971年，由著名的计算机科学家艾兹格•迪科斯彻提出，即假设有五台计算机都试图访问五份共享的磁带驱动器。不久，为了便于理解和生动化，这个问题又被托尼•霍尔重新表述为哲学家就餐问题。该问题可以用来解释死锁和资源竞争。">
<meta property="og:type" content="article">
<meta property="og:title" content="Java多线程之哲学家就餐问题">
<meta property="og:url" content="http://www.leechain.top/2017/11/20/java-multithreads-philosopher-dinner-learn/index.html">
<meta property="og:site_name" content="Qwerty Everyday.">
<meta property="og:description" content="Java多线程之哲学家就餐问题哲学家就餐问题是在计算机科学中的一个经典问题，常常被用来面试。这个问题显示了多线程同步(Synchronization)时产生的问题。 在1971年，由著名的计算机科学家艾兹格•迪科斯彻提出，即假设有五台计算机都试图访问五份共享的磁带驱动器。不久，为了便于理解和生动化，这个问题又被托尼•霍尔重新表述为哲学家就餐问题。该问题可以用来解释死锁和资源竞争。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.leechain.top/uploads/multithreads-basic-knowledge/19.jpg">
<meta property="og:image" content="http://www.leechain.top/uploads/multithreads-basic-knowledge/20.png">
<meta property="og:image" content="http://www.leechain.top/uploads/multithreads-basic-knowledge/21.png">
<meta property="article:published_time" content="2017-11-19T16:00:00.000Z">
<meta property="article:modified_time" content="2017-12-09T05:23:26.000Z">
<meta property="article:author" content="Chain Qian">
<meta property="article:tag" content="学习">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="多线程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.leechain.top/uploads/multithreads-basic-knowledge/19.jpg">

<link rel="canonical" href="http://www.leechain.top/2017/11/20/java-multithreads-philosopher-dinner-learn/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Java多线程之哲学家就餐问题 | Qwerty Everyday.</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Qwerty Everyday.</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">/* hello world */</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.leechain.top/2017/11/20/java-multithreads-philosopher-dinner-learn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/custom-avatar.jpg">
      <meta itemprop="name" content="Chain Qian">
      <meta itemprop="description" content="// todo sth">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Qwerty Everyday.">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Java多线程之哲学家就餐问题
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-11-20 00:00:00" itemprop="dateCreated datePublished" datetime="2017-11-20T00:00:00+08:00">2017-11-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Java多线程之哲学家就餐问题"><a href="#Java多线程之哲学家就餐问题" class="headerlink" title="Java多线程之哲学家就餐问题"></a>Java多线程之哲学家就餐问题</h1><p>哲学家就餐问题是在计算机科学中的一个经典问题，常常被用来面试。这个问题显示了多线程同步(Synchronization)时产生的问题。</p>
<p>在1971年，由著名的计算机科学家艾兹格•迪科斯彻提出，即假设有五台计算机都试图访问五份共享的磁带驱动器。不久，为了便于理解和生动化，这个问题又被托尼•霍尔重新表述为哲学家就餐问题。该问题可以用来解释死锁和资源竞争。</p>
<p><a href="https://www.leechain.top/blog/2017/08/25-operation-system-multithreads.html">操作系统原理之进程和线程管理</a><br><a href="https://www.leechain.top/blog/2017/08/21-java-concurrency-brief.html">Java的多线程和并发知识纲要</a><br><a href="https://www.leechain.top/blog/2017/08/27-java-multithreads-producer-and-consumer-learn.html">Java多线程之生产者和消费者模式</a></p>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>一张圆桌上坐着5名哲学家，每两个哲学家之间的桌上摆一根筷子，桌子的中间是一碗米饭，如下图所示。哲学家们倾注毕生精力用于思考和进餐，哲学家在思考时，并不影响他人。每个哲学家思考的时间是固定的，不是永久都在思考。只有当哲学家饥饿的时候，才试图拿起左、 右两根筷子（一根一根地拿起）。如果筷子已在他人手上，则需等待。这个等待可能是一直等待，也有可能是等待一会就放弃（同时放下手中已有的筷子）。饥饿的哲学家只有同时拿到了两根筷子才可以开始进餐。同样，每个哲学家吃饭的时间是固定的，不是一直都在吃饭。当进餐完毕后，放下筷子继续思考。</p>
<p><img src="/uploads/multithreads-basic-knowledge/19.jpg" alt="哲学家就餐问题"></p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>5名哲学家与左右邻居对其中间筷子的访问是__互斥关系__，可以把哲学家比作五个进程。问题的关键是如何让一个哲学家能吃到饭而不造成__死锁或者饥饿__现象。</p>
<p>每一个哲学家的状态可以分为：思考（无需筷子）、饥饿（需要筷子）、吃饭（占有两个筷子）。</p>
<p>如果不设计好哲学家的吃饭规则，那么会导致死锁和饥饿。<br>假设五个哲学家按顺序分别是A，B，C，D，E。</p>
<p>死锁的例子：<br>大家都同时拿起左边的筷子，然后等待右边的筷子。即A拿到了筷子2，然后等待筷子1；E拿到了1，再等待5；D拿到了5，再等待4；C拿到了4，再等待3；B拿到了3，再等待2；而A一直不放下筷子2。那么就形成了死锁。</p>
<p>饥饿的例子：<br>基于死锁的例子，不同的是，大家先检查右边的筷子是否可以拿，发现可以，然后都同时拿起左边的筷子，接着又同时去拿右边的筷子，但是发现右边拿不到（相对的），就同时放下了左手的筷子，放下筷子后又发现自己右边的筷子可以拿了，就又同时拿起了左边的筷子。循环往复，那么就形成了饥饿。</p>
<p>在这个问题中，不难发现，最多只有两个哲学家能同时就餐，而正确的情况是每个哲学家都能吃到饭。</p>
<h2 id="我的解决"><a href="#我的解决" class="headerlink" title="我的解决"></a>我的解决</h2><p>解决这个问题需要设计正确的吃饭规则，不能想吃就吃。</p>
<p>比如：<br>1）同时只允许一位哲学家就餐。<br>2）对哲学家顺序编号，要求奇数号哲学家先抓左边的叉子，然后再抓他右边的叉子；而偶数号哲学家刚好相反，先抓右边的叉子，然后再抓他左边的叉子。<br>3）当且仅当某一个哲学家他的左右两边的叉子都可用时，才允许抓起叉子。</p>
<p>做法一可行但是效率低，本来可以最多两个哲学家吃饭，现在只能是一个。<br>做法二可行，不过需要对哲学家分类，也就是进程分类，操作比较麻烦，需要制定两套方案。<br>做法三也是可行的，同时也是不错的解决方法，每个哲学家都是平等的。</p>
<p>PV操作模型可以直观的表示这些方法，不过落实到具体的代码上就不是模型表现的那么简单了，好在JavaAPI已经提供了相关的类或方法可以直接使用。</p>
<h3 id="公共类和方法"><a href="#公共类和方法" class="headerlink" title="公共类和方法"></a>公共类和方法</h3><p>抽象的筷子类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chain.test.day04;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 筷子的抽象类</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 临界资源，只能同时被一个哲学家使用（抓起）</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> chain</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractChopstick</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 筷子序号</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbstractChopstick</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得筷子序号</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得筷子名字</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Chopstick-&quot;</span> + getId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 筷子是否被使用</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isUse</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用（抓起）筷子</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">use</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 放下筷子</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">drop</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>哲学家抽象类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chain.test.day04;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 哲学家抽象类</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> chain</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractPhilosopher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 哲学家序号</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbstractPhilosopher</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得哲学家的序号</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得哲学家的名字</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Philosopher-&quot;</span> + getId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 思考</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">think</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 抓筷子</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">take</span><span class="params">(AbstractChopstick chopstick)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 放筷子</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(AbstractChopstick chopstick)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 就餐</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>哲学家就餐的方法的抽象类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chain.test.day04;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 哲学家抓放筷子的方法的抽象类</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> chain</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractPhilosopherMethod</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 哲学家</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 吃饭在前，思考在后</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">(Philosopher p, AbstractChopstick[] cs)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试方法、Philosopher、Chopstick的具体实现可以文章底部源码连接中可以查阅到。</p>
<p>对于Chopstick这个临界资源，实现PV操作的方式有多种。</p>
<h3 id="先拿起左叉子，再拿起右叉子"><a href="#先拿起左叉子，再拿起右叉子" class="headerlink" title="先拿起左叉子，再拿起右叉子"></a>先拿起左叉子，再拿起右叉子</h3><p>test.properties：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chopstick.class=com.chain.test.day04.Chopstick01</span><br><span class="line">philosopher.class=com.chain.test.day04.Philosopher</span><br><span class="line">philosopher.method.class=com.chain.test.day04.PhilosopherMethod01</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chain.test.day04;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 每个哲学家先拿起左叉子，再拿起右叉子</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> chain</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhilosopherMethod01</span> <span class="keyword">extends</span> <span class="title">AbstractPhilosopherMethod</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">(Philosopher p, AbstractChopstick[] cs)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> left = p.getId();</span><br><span class="line">        <span class="keyword">int</span> right = (left + <span class="number">1</span>) % cs.length;</span><br><span class="line"></span><br><span class="line">        p.take(cs[left]);</span><br><span class="line">        p.take(cs[right]);</span><br><span class="line"></span><br><span class="line">        p.eat();</span><br><span class="line"></span><br><span class="line">        p.put(cs[left]);</span><br><span class="line">        p.put(cs[right]);</span><br><span class="line"></span><br><span class="line">        p.think();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法绝大多数情况下是能正常工作的，但是也是存在问题的，比如如果每个哲学家同时拿起左叉子，都在等待右叉子时就会造成死锁。<br>当然也不是不能打破这个死锁，可以设置等待超时时间。这样这个方案虽然不能避免死锁，但是能打破死锁。</p>
<p>死锁发生时的情况：</p>
<p><img src="/uploads/multithreads-basic-knowledge/20.png" alt="死锁发生"></p>
<h3 id="同时只允许一位哲学家就餐"><a href="#同时只允许一位哲学家就餐" class="headerlink" title="同时只允许一位哲学家就餐"></a>同时只允许一位哲学家就餐</h3><p>同时只允许一位哲学家就餐，换句话说就是某一个哲学家取筷子的时候，把所有的筷子都霸占，使得其他哲学家都不能碰筷子。把所有的筷子作为一个整体是一个临界资源。</p>
<p>test.properties：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chopstick.class=com.chain.test.day04.Chopstick01</span><br><span class="line">philosopher.class=com.chain.test.day04.Philosopher</span><br><span class="line">philosopher.method.class=com.chain.test.day04.PhilosopherMethod02</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chain.test.day04;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 同时只允许一位哲学家就餐</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> chain</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhilosopherMethod02</span> <span class="keyword">extends</span> <span class="title">AbstractPhilosopherMethod</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">(Philosopher p, AbstractChopstick[] cs)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> left = p.getId();</span><br><span class="line">        <span class="keyword">int</span> right = (left + <span class="number">1</span>) % cs.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (cs) &#123;</span><br><span class="line">            p.take(cs[left]);</span><br><span class="line">            p.take(cs[right]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p.eat();</span><br><span class="line"></span><br><span class="line">        p.put(cs[left]);</span><br><span class="line">        p.put(cs[right]);</span><br><span class="line"></span><br><span class="line">        p.think();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样做，会造成效率降低。从运行结果中可以看到运行速度降低，并且每次确实只有一个哲学家在抓筷子。</p>
<h3 id="哲学家分成奇偶"><a href="#哲学家分成奇偶" class="headerlink" title="哲学家分成奇偶"></a>哲学家分成奇偶</h3><p>死锁之所以会发生主要是在P操作，释放筷子的V操作不会发生阻塞。</p>
<p>test.properties：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chopstick.class=com.chain.test.day04.Chopstick01</span><br><span class="line">philosopher.class=com.chain.test.day04.Philosopher</span><br><span class="line">philosopher.method.class=com.chain.test.day04.PhilosopherMethod03</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chain.test.day04;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 哲学家分成奇偶</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> chain</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhilosopherMethod03</span> <span class="keyword">extends</span> <span class="title">AbstractPhilosopherMethod</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">(Philosopher p, AbstractChopstick[] cs)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> id = p.getId();</span><br><span class="line">        <span class="keyword">int</span> left = id;</span><br><span class="line">        <span class="keyword">int</span> right = (left + <span class="number">1</span>) % cs.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((id &amp; <span class="number">1</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">            p.take(cs[left]);</span><br><span class="line">            p.take(cs[right]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            p.take(cs[right]);</span><br><span class="line">            p.take(cs[left]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p.eat();</span><br><span class="line"></span><br><span class="line">        p.put(cs[left]);</span><br><span class="line">        p.put(cs[right]);</span><br><span class="line"></span><br><span class="line">        p.think();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样的解决可行，不过不算很通用。</p>
<h3 id="当且仅当两个筷子都可以"><a href="#当且仅当两个筷子都可以" class="headerlink" title="当且仅当两个筷子都可以"></a>当且仅当两个筷子都可以</h3><p>要么不拿，要么就拿两把筷子。</p>
<p>哲学家此时就有三种状态：思考状态（不用筷子）、饥饿状态（等待左右筷子）、就餐状态（使用筷子）。</p>
<p>此时的操作就是对哲学家的状态的操作，哲学家的“状态”成为临界资源，而筷子就能合理分配，不需要再做互斥处理，可以简化设计。</p>
<p>当某个哲学家在饥饿状态时，他需要筷子吃饭，如果此时他的两边哲学家都不在就餐状态时，他就可以顺利的拿到左右手的筷子吃到饭，并进入就餐状态。<br>当某个哲学家在饥饿状态时，两边只要有一个在就餐，那么他就不可以拿到左右手的筷子，也就吃不到饭，一直保持饥饿状态（或者等待一会后放弃继续进入思考状态）。<br>当某个哲学家吃完饭后，放下筷子后通知两边的哲学家，接着进入思考状态。</p>
<p>test.properties：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chopstick.class=com.chain.test.day04.Chopstick01</span><br><span class="line">philosopher.class=com.chain.test.day04.Philosopher</span><br><span class="line">philosopher.method.class=com.chain.test.day04.PhilosopherMethod04</span><br></pre></td></tr></table></figure>

<p>哲学家Status：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Status &#123;</span><br><span class="line">    THINK, HUNGRY, EAT</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用Object的wait和notify实现对Status的PV操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chain.test.day04;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 当且仅当两个筷子都可以</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 使用wait和notify</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> chain</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhilosopherMethod04</span> <span class="keyword">extends</span> <span class="title">AbstractPhilosopherMethod</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Status[] status;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PhilosopherMethod04</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        status = <span class="keyword">new</span> Status[Main.PHILOSOPHER_NUM];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; status.length; i++)</span><br><span class="line">            status[i] = Status.HUNGRY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">(AbstractPhilosopher p, AbstractChopstick[] cs)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        takes(p, cs);</span><br><span class="line"></span><br><span class="line">        p.eat();</span><br><span class="line"></span><br><span class="line">        puts(p, cs);</span><br><span class="line"></span><br><span class="line">        p.think();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 放下手中的筷子，并通知其他所有的哲学家</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cs</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">puts</span><span class="params">(AbstractPhilosopher p, AbstractChopstick[] cs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> id = p.getId();</span><br><span class="line">        <span class="keyword">int</span> right = (id + <span class="number">1</span>) % Main.PHILOSOPHER_NUM;</span><br><span class="line">        p.put(cs[id]);</span><br><span class="line">        p.put(cs[right]);</span><br><span class="line">        status[p.getId()] = Status.THINK;</span><br><span class="line">        <span class="keyword">this</span>.notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 尝试同时抓起两边的筷子</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cs</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">takes</span><span class="params">(AbstractPhilosopher p, AbstractChopstick[] cs)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> id = p.getId();</span><br><span class="line">        status[id] = Status.HUNGRY;</span><br><span class="line">        trial(p, cs);</span><br><span class="line">        <span class="keyword">while</span> (status[id] != Status.EAT) &#123;</span><br><span class="line">            <span class="keyword">this</span>.wait();</span><br><span class="line">            trial(p, cs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">trial</span><span class="params">(AbstractPhilosopher p, AbstractChopstick[] cs)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> id = p.getId();</span><br><span class="line">        <span class="keyword">int</span> n = Main.PHILOSOPHER_NUM;</span><br><span class="line">        <span class="keyword">int</span> left = (id - <span class="number">1</span> + n) % n;</span><br><span class="line">        <span class="keyword">int</span> right = (id + <span class="number">1</span>) % n;</span><br><span class="line">        <span class="keyword">if</span> (status[id] == Status.HUNGRY &amp;&amp; status[left] != Status.EAT &amp;&amp; status[right] != Status.EAT) &#123;</span><br><span class="line">            p.take(cs[id]);</span><br><span class="line">            p.take(cs[right]);</span><br><span class="line">            status[id] = Status.EAT;</span><br><span class="line">            <span class="keyword">this</span>.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>test.properties：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chopstick.class=com.chain.test.day04.Chopstick01</span><br><span class="line">philosopher.class=com.chain.test.day04.Philosopher</span><br><span class="line">philosopher.method.class=com.chain.test.day04.PhilosopherMethod05</span><br></pre></td></tr></table></figure>

<p>使用ReentrantLock和Condition实现Status的PV操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chain.test.day04;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 当且仅当两个筷子都可以</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 使用ReentrantLock和Condition</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> chain</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhilosopherMethod05</span> <span class="keyword">extends</span> <span class="title">AbstractPhilosopherMethod</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ReentrantLock lock;</span><br><span class="line">    <span class="keyword">private</span> Condition[] cond;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Status[] status;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PhilosopherMethod05</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        status = <span class="keyword">new</span> Status[Main.PHILOSOPHER_NUM];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; status.length; i++)</span><br><span class="line">            status[i] = Status.HUNGRY;</span><br><span class="line"></span><br><span class="line">        lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">        cond = <span class="keyword">new</span> Condition[Main.PHILOSOPHER_NUM];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cond.length; i++)</span><br><span class="line">            cond[i] = lock.newCondition();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">(AbstractPhilosopher p, AbstractChopstick[] cs)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        takes(p, cs);</span><br><span class="line"></span><br><span class="line">        p.eat();</span><br><span class="line"></span><br><span class="line">        puts(p, cs);</span><br><span class="line"></span><br><span class="line">        p.think();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 放下手中的筷子，并通知两边的哲学家</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cs</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">puts</span><span class="params">(AbstractPhilosopher p, AbstractChopstick[] cs)</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> id = p.getId();</span><br><span class="line">            <span class="keyword">int</span> n = Main.PHILOSOPHER_NUM;</span><br><span class="line">            <span class="keyword">int</span> left = (id - <span class="number">1</span> + n) % n;</span><br><span class="line">            <span class="keyword">int</span> right = (id + <span class="number">1</span>) % n;</span><br><span class="line">            p.put(cs[id]);</span><br><span class="line">            p.put(cs[right]);</span><br><span class="line">            status[p.getId()] = Status.THINK;</span><br><span class="line">            trial(left, cs);</span><br><span class="line">            trial(right, cs);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (lock.isLocked())</span><br><span class="line">                lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 尝试同时抓起两边的筷子</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cs</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">takes</span><span class="params">(AbstractPhilosopher p, AbstractChopstick[] cs)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> id = p.getId();</span><br><span class="line">            status[id] = Status.HUNGRY;</span><br><span class="line">            trial(id, cs);</span><br><span class="line">            <span class="keyword">while</span> (status[id] != Status.EAT)</span><br><span class="line">                cond[id].await();</span><br><span class="line">            <span class="keyword">if</span> (status[id] == Status.EAT) &#123;</span><br><span class="line">                <span class="keyword">int</span> right = (id + <span class="number">1</span>) % Main.PHILOSOPHER_NUM;</span><br><span class="line">                p.take(cs[id]);</span><br><span class="line">                p.take(cs[right]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (lock.isLocked())</span><br><span class="line">                lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">trial</span><span class="params">(<span class="keyword">int</span> id, AbstractChopstick[] cs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = Main.PHILOSOPHER_NUM;</span><br><span class="line">        <span class="keyword">int</span> left = (id - <span class="number">1</span> + n) % n;</span><br><span class="line">        <span class="keyword">int</span> right = (id + <span class="number">1</span>) % n;</span><br><span class="line">        <span class="keyword">if</span> (status[id] == Status.HUNGRY &amp;&amp; status[left] != Status.EAT &amp;&amp; status[right] != Status.EAT) &#123;</span><br><span class="line">            status[id] = Status.EAT;</span><br><span class="line">            cond[id].signal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在别的博客看到还有另外一种做法，将筷子和哲学家进行颠倒，哲学家成为临界资源，而由筷子去选择哲学家。</p>
<h2 id="思考总结"><a href="#思考总结" class="headerlink" title="思考总结"></a>思考总结</h2><p>修改test.properties中的chopstick.class也是类似的效果，比如同时抓起左筷子并等待右筷子时会死锁。</p>
<p>正常的情况如下：</p>
<p><img src="/uploads/multithreads-basic-knowledge/21.png" alt="正常情况"></p>
<p>解决这个问题的一开始自然的想法就是，所有的哲学家先尝试去拿左边的筷子，如果拿到了就再去尝试拿右边的筷子，如果没有拿到左边的筷子，就一直处于饥饿状态，直到可以拿到左边的筷子。如果拿到了右边的筷子，哲学家就进入就餐状态，就餐状态执行一段时间后哲学家放下手中的两只筷子，并进入思考状态。放下筷子后两边的哲学家就可以得到他们需要的左手筷子或右手筷子。</p>
<p>这样的方法乍一看上去是没有问题的，但是如果所有的哲学家都同时成功的拿起了左边的筷子，然后去等待右边的筷子，而右边的筷子显然一直会被右边的哲学家抓在他的左手中。那么就会造成死锁。除非有哲学家主动放下左手中的筷子，这个死锁才可能解除。</p>
<p>解决这个问题的方法主要有三种。</p>
<p>第一种简单粗暴，就是只允许同时只有一个哲学家能去拿筷子，注意不是整个就餐，只要保证拿筷子的过程是独占的即可。这样的操作自然不会有死锁问题，缺陷就是原本最多可以有两个哲学家能同时并成功的拿到筷子，现在只能有一个。执行的效率会降低。</p>
<p>第二种比较有技巧性，就是将哲学家分成奇偶。奇数先尝试拿左再拿右，偶数先尝试拿右再拿左。这样仔细分析一下：如果奇数的哲学家先拿到了左手的筷子，然后去拿右手边的筷子，而与此同时偶数的哲学家（就在奇数的哲学家两旁），会先去尝试拿右边的筷子，左边的筷子只会在右边的筷子成功拿到后才会去尝试拿。对于奇数的哲学家来说，右手的筷子直接可以拿到，因为他旁边的哲学家（也是偶数哲学家）在尝试拿他的右手边的筷子，根本不会去管他左边的筷子。对于偶数的哲学家来说，他想先去拿右手边得筷子，但是发现右手边的筷子被他右边的哲学家已经握在了左手中，就会一直处于饥饿状态等待。当奇数的哲学家拿到筷子并饱餐一顿放下筷子后，偶数的哲学家也就能拿到一直渴望的右手边的筷子，拿到右手边的筷子后，由于奇数的哲学家刚刚吃完在思考并不会去碰筷子，偶数的哲学家也能顺利的拿到左手边的筷子开始就餐。这样循环下去，能正常执行。</p>
<p>第三种，对问题进行了升华。哲学家要么一次拿起面前的两双筷子开吃，要么就不拿。原本筷子是临界资源，这种方法将临界资源改为哲学家的“状态”（同时原本的筷子无需再进行独占设计）。哲学家的状态可以划分为三种：思考状态（无需筷子）、饥饿状态（需要筷子）、就餐状态（占有筷子）。具体分析一下：需要就餐，处在饥饿状态的哲学家会先看看他两边的哲学家的状态。如果两边的哲学家都沉浸在自己的思考中，即思考状态，并不需要筷子，那么这个哲学家可以拿起两边的筷子开始就餐，进入就餐状态。如果他两边只要有一个哲学家在就餐状态，那么也就意味着他面前的筷子是不足两只的，他就保持饥饿状态等待。就餐完毕的哲学家放下手中的筷子，在进入思考状态前“告知”一下旁边的两位哲学家，“我已经吃完，你们可以拿我刚放下的筷子了”，然后就立即进入思考状态。因为不会存在相邻两个哲学家都在就餐的情况，只会存在相邻两个哲学家都在思考或饥饿，所以获得通知的饥饿中的哲学家会再次尝试去判断他两边哲学家的状态，如果两边的哲学家都处于思考状态，那么这个哲学家可以拿起两边的筷子并进入就餐状态，如果仍然不行则继续等待。这种方法能保证最多两个哲学家同时就餐，最多三个哲学家同时在等待，不会都在等待状态，所以能正常执行。</p>
<p>经典问题搞懂，能做到举一反三。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ChainGit/some-tests/tree/master/test06">源码</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%AD%A6%E4%B9%A0/" rel="tag"># 学习</a>
              <a href="/tags/Java/" rel="tag"># Java</a>
              <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag"># 多线程</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2017/11/15/java-huffman-codec/" rel="prev" title="Java实现基于哈夫曼的压缩算法">
      <i class="fa fa-chevron-left"></i> Java实现基于哈夫曼的压缩算法
    </a></div>
      <div class="post-nav-item">
    <a href="/2017/11/25/java-multithreads-read-write-learn/" rel="next" title="Java多线程之读者写者问题">
      Java多线程之读者写者问题 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8B%E5%93%B2%E5%AD%A6%E5%AE%B6%E5%B0%B1%E9%A4%90%E9%97%AE%E9%A2%98"><span class="nav-number">1.</span> <span class="nav-text">Java多线程之哲学家就餐问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="nav-number">1.1.</span> <span class="nav-text">问题描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="nav-number">1.2.</span> <span class="nav-text">问题分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%88%91%E7%9A%84%E8%A7%A3%E5%86%B3"><span class="nav-number">1.3.</span> <span class="nav-text">我的解决</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%AC%E5%85%B1%E7%B1%BB%E5%92%8C%E6%96%B9%E6%B3%95"><span class="nav-number">1.3.1.</span> <span class="nav-text">公共类和方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%88%E6%8B%BF%E8%B5%B7%E5%B7%A6%E5%8F%89%E5%AD%90%EF%BC%8C%E5%86%8D%E6%8B%BF%E8%B5%B7%E5%8F%B3%E5%8F%89%E5%AD%90"><span class="nav-number">1.3.2.</span> <span class="nav-text">先拿起左叉子，再拿起右叉子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8C%E6%97%B6%E5%8F%AA%E5%85%81%E8%AE%B8%E4%B8%80%E4%BD%8D%E5%93%B2%E5%AD%A6%E5%AE%B6%E5%B0%B1%E9%A4%90"><span class="nav-number">1.3.3.</span> <span class="nav-text">同时只允许一位哲学家就餐</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%93%B2%E5%AD%A6%E5%AE%B6%E5%88%86%E6%88%90%E5%A5%87%E5%81%B6"><span class="nav-number">1.3.4.</span> <span class="nav-text">哲学家分成奇偶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BD%93%E4%B8%94%E4%BB%85%E5%BD%93%E4%B8%A4%E4%B8%AA%E7%AD%B7%E5%AD%90%E9%83%BD%E5%8F%AF%E4%BB%A5"><span class="nav-number">1.3.5.</span> <span class="nav-text">当且仅当两个筷子都可以</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%9D%E8%80%83%E6%80%BB%E7%BB%93"><span class="nav-number">1.4.</span> <span class="nav-text">思考总结</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Chain Qian"
      src="/uploads/custom-avatar.jpg">
  <p class="site-author-name" itemprop="name">Chain Qian</p>
  <div class="site-description" itemprop="description">// todo sth</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">75</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/chaingit" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chaingit" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:chainz@foxmail.com" title="E-Mail → mailto:chainz@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">苏ICP备16052713号-1 </a>
  </div>

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chain Qian</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
